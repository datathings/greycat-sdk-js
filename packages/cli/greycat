#!/bin/sh

SCRIPT_PATH=""
computeAbsPath() {
  OURPWD=$PWD
  cd "$(dirname "$1")"
  LINK=$(readlink "$(basename "$1")")
  while [ "$LINK" ]; do
    cd "$(dirname "$LINK")"
    LINK=$(readlink "$(basename "$1")")
  done
  REALPATH="$PWD/$(basename "$1")"
  cd "$OURPWD"
  SCRIPT_PATH="$REALPATH"
}
computeAbsPath "$0"
SCRIPT_DIRECTORY="$( cd "$( dirname "${SCRIPT_PATH}" )" >/dev/null 2>&1 && pwd )"

PLATFORM=$(uname -s)
ARCH=$(uname -m)

case $PLATFORM in
  Darwin)
    "${SCRIPT_DIRECTORY}/bin/x64-mac/greycat" "$@"
    ;;
  Linux)
    case $ARCH in
      x86_64)
        "${SCRIPT_DIRECTORY}/bin/x64-cuda-11/greycat" -v &> /dev/null
        [ $? -eq 0 ] && "${SCRIPT_DIRECTORY}/bin/x64-cuda-11/greycat" "$@" && exit $?;
        # unable to find cuda-11
        "${SCRIPT_DIRECTORY}/bin/x64-cuda-10-2/greycat" -v &> /dev/null
        [ $? -eq 0 ] && "${SCRIPT_DIRECTORY}/bin/x64-cuda-10-2/greycat" "$@" && exit $?;
        # unable to find cuda-10-2
        "${SCRIPT_DIRECTORY}/bin/x64-libc/greycat" "$@"
        ;;
      arm64)
        "${SCRIPT_DIRECTORY}/bin/aarch64-libc/greycat" "$@"
        ;;
      aarch64)
        "${SCRIPT_DIRECTORY}/bin/aarch64-libc/greycat" "$@"
        ;;
      armv7)
        "${SCRIPT_DIRECTORY}/bin/armv7-eabihf-libc/greycat" "$@"
        ;;
      armv7l)
        "${SCRIPT_DIRECTORY}/bin/armv7-eabihf-libc/greycat" "$@"
        ;;
      *)
      echo "Greycat is not supported on $PLATFORM:$ARCH yet!"
      exit 1
      ;;
    esac
    ;;
  *)
    echo "Greycat is not supported on $PLATFORM yet!"
    exit 1
    ;;
esac
